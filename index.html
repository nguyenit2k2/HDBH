<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o H√≥a ƒê∆°n B√°n H√†ng Nhanh</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i th∆∞ vi·ªán jsPDF ƒë·ªÉ t·∫°o file PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- T·∫£i th∆∞ vi·ªán html2canvas ƒë·ªÉ chuy·ªÉn ƒë·ªïi HTML sang Canvas (c·∫ßn cho jsPDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Thi·∫øt l·∫≠p font ch·ªØ theo y√™u c·∫ßu */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }

        /* ƒê·ªãnh d·∫°ng cho b·∫£n in (PDF/Gi·∫•y) */
        @media print {
            body > * {
                display: none; /* ·∫®n m·ªçi th·ª© tr·ª´ ph·∫ßn preview khi in */
            }
            #invoice-preview {
                display: block !important;
                margin: 0;
                padding: 0;
                box-shadow: none;
                max-width: 100%;
                width: 7.75in; /* Chi·ªÅu r·ªông trang A4 ti√™u chu·∫©n (7.75 inch) */
            }
            .no-print {
                display: none !important;
            }

            /* ƒê·∫£m b·∫£o b·∫£ng hi·ªÉn th·ªã ƒë√∫ng */
            #invoice-preview table {
                width: 100% !important;
                border-collapse: collapse;
            }

            /* ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc font cho b·∫£n in */
            #invoice-preview {
                font-size: 11pt !important;
            }
            #invoice-preview table {
                font-size: 10pt !important;
            }
        }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 md:p-8 flex flex-col lg:flex-row gap-8">
        
        <!-- Khu v·ª±c Nh·∫≠p li·ªáu (Input Form) -->
        <div id="input-form" class="no-print lg:w-1/3 bg-white p-6 rounded-xl shadow-lg h-fit sticky top-4">
            <h2 class="text-2xl font-bold mb-6 text-red-600">üìù Nh·∫≠p Li·ªáu H√≥a ƒê∆°n</h2>
            
            <form id="invoice-form" onsubmit="event.preventDefault(); generateInvoice();">
                <!-- Th√¥ng tin H·ªô Kinh Doanh -->
                <div class="mb-6 border-b pb-4">
                    <h3 class="font-semibold text-lg mb-3 text-gray-700">Th√¥ng tin H·ªô Kinh Doanh</h3>
                    <input type="text" id="ten_cong_ty" placeholder="T√™n H·ªô/C√¥ng ty (VD: C√îNG TY HO√ÄNG PH√öC)" class="w-full p-2 mb-2 border rounded-lg focus:ring-blue-500" value="H·ªò KINH DOANH QU·ªêC AN LK" required>
                    <input type="text" id="dia_chi" placeholder="ƒê·ªãa ch·ªâ (VD: B·∫£n Na Kay...)" class="w-full p-2 mb-2 border rounded-lg" value="14 Nguy·ªÖn Tr∆∞·ªùng T·ªô, Ph∆∞·ªùng Long Kh√°nh, T·ªânh ƒê·ªìng Nai" required>
                    <input type="tel" id="dien_thoai" placeholder="(VD: 020 5806 2626)" class="w-full p-2 mb-2 border rounded-lg" value="0348546624" required>
                
                    <div class="grid grid-cols-3 gap-2 mt-4">
                        <input type="number" id="gio" placeholder="Gi·ªù" class="w-full p-2 border rounded-lg" value="15" min="0" max="23" required>
                        <input type="number" id="phut" placeholder="Ph√∫t" class="w-full p-2 border rounded-lg" value="10" min="0" max="59" required>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mt-4">
                        <input type="number" id="ngay" placeholder="Ng√†y" class="w-full p-2 border rounded-lg" value="15" min="1" max="31" required>
                        <input type="number" id="thang" placeholder="Th√°ng" class="w-full p-2 border rounded-lg" value="10" min="1" max="12" required>
                        <input type="number" id="nam" placeholder="NƒÉm" class="w-full p-2 border rounded-lg" value="2025" required>
                    </div>
                    <input type="text" id="so_hoa_don" placeholder="S·ªë H√≥a ƒê∆°n (VD: 0000001)" class="w-full p-2 mt-2 border rounded-lg" value="0000001" required>
                </div>

                <!-- Th√¥ng tin Kh√°ch h√†ng -->
                <div class="mb-6 border-b pb-4">
                    <h3 class="font-semibold text-lg mb-3 text-gray-700">Th√¥ng tin Kh√°ch h√†ng</h3>
                    <input type="text" id="ten_nguoi_mua" placeholder="H·ªç t√™n ng∆∞·ªùi mua" class="w-full p-2 mb-2 border rounded-lg" required>
                </div>

                <!-- Th√¥ng tin T√≠nh to√°n T·ª± ƒë·ªông -->
                <div class="mb-6 pb-4">
                    <h3 class="font-semibold text-lg mb-3 text-gray-700">T√≠nh to√°n T·ª± ƒë·ªông (Gas & D·ªãch v·ª•)</h3>
                    
                    <!-- Input cho T·ªïng s·ªë ti·ªÅn -->
                    <label for="tong_so_tien_input" class="block text-sm font-medium text-gray-700 mb-1">T·ªïng s·ªë ti·ªÅn Kh√°ch tr·∫£ (VNƒê)</label>
                    <input 
                        type="text" 
                        id="tong_so_tien_input" 
                        placeholder="VD: 550.000" 
                        class="w-full p-2 mb-3 border-2 border-red-400 rounded-lg focus:ring-red-500 focus:border-red-500 font-bold" 
                        oninput="formatNumber(this)"
                        value="550.000"
                        required>

                    <!-- Input s·ªë ti·ªÅn b·∫±ng ch·ªØ (Gi·ªØ nguy√™n) -->
                    <label for="so_tien_chu" class="block text-sm font-medium text-gray-700 mb-1">S·ªë ti·ªÅn b·∫±ng ch·ªØ</label>
                    <input type="text" id="so_tien_chu" placeholder="S·ªë ti·ªÅn b·∫±ng ch·ªØ (B·∫Øt bu·ªôc)" class="w-full p-2 border rounded-lg" value="NƒÉm trƒÉm nƒÉm m∆∞∆°i ng√†n ƒë·ªìng ch·∫µn" required>
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition duration-150 shadow-md">
                    Xem & T·∫°o H√≥a ƒê∆°n
                </button>
            </form>
            
            <button id="download-button" onclick="downloadPDF()" class="w-full mt-3 bg-red-600 text-white p-3 rounded-lg font-bold hover:bg-red-700 transition duration-150 shadow-md hidden">
                T·∫£i Xu·ªëng PDF (Ti√™u chu·∫©n)
            </button>
            <button id="print-button" onclick="window.print()" class="w-full mt-3 bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition duration-150 shadow-md hidden">
                In ra PDF / Gi·∫•y
            </button>
        </div>

        <!-- Khu v·ª±c Preview (Template H√≥a ƒë∆°n) -->
        <div class="lg:w-2/3">
            <div id="invoice-preview" class="bg-white p-6 shadow-xl rounded-xl hidden" style="font-family: 'Times New Roman', serif; font-size: 11pt; line-height: 1.2; width: 7.75in;">
                
                <div class="text-right mb-4">
                    <span id="preview-date-number">Ng√†y ... th√°ng ... nƒÉm 20... S·ªë: 0000001</span>
                </div>

                <div class="text-center mb-6">
                    <span class="text-lg font-bold text-red-600">H√ìA ƒê∆†N B√ÅN H√ÄNG</span>
                </div>

                <!-- Th√¥ng tin H·ªô Kinh Doanh -->
                <div class="text-sm space-y-0.5 mb-4">
                    <div>
                        <span class="text-red-600 font-bold">ƒê∆°n v·ªã b√°n h√†ng:</span> <span id="preview-ten-cong-ty">...</span>
                    </div>
                    <div>
                        <span class="text-red-600 font-bold">ƒê·ªãa ch·ªâ:</span> <span id="preview-dia_chi">...</span> 
                    </div>
                    <div>
                        <span class="text-red-600 font-bold">ƒêi·ªán tho·∫°i:</span> <span id="preview-dien_thoai"></span>
                    </div>
                </div>

                <!-- Th√¥ng tin Kh√°ch h√†ng -->
                <div class="grid grid-cols-12 gap-1 text-sm mb-4">
                    <div class="col-span-8">
                        <span class="whitespace-nowrap">H·ªç t√™n ng∆∞·ªùi mua: <span id="preview-ten-nguoi-mua"></span></span>
                        <div class="border-b border-dotted border-gray-500 leading-none mt-0.5"></div>
                    </div>
                </div>

                <!-- B·∫£ng H√†ng h√≥a (B√¢y gi·ªù t·ª± ƒë·ªông ƒëi·ªÅn) -->
                <table class="w-full border border-black mb-4 text-sm" id="product-table">
                    <thead>
                        <tr class="text-center font-bold text-red-600 bg-gray-50">
                            <td class="border border-black p-1 w-[5%]">STT</td>
                            <td class="border border-black p-1 w-[35%]">T√™n h√†ng h√≥a</td>
                            <td class="border border-black p-1 w-[10%]">ƒêVT</td>
                            <td class="border border-black p-1 w-[10%]">S·ªë l∆∞·ª£ng</td>
                            <td class="border border-black p-1 w-[10%]">ƒê∆°n gi√°</td>
                            <td class="border border-black p-1 w-[15%]">Th√†nh ti·ªÅn</td>
                            <td class="border border-black p-1 w-[15%]">Ghi ch√∫</td>
                        </tr>
                    </thead>
                    <tbody id="product-table-body">
                        <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông b·∫±ng JS -->
                    </tbody>
                </table>
                
                <!-- S·ªë ti·ªÅn b·∫±ng ch·ªØ -->
                <div class="text-sm mb-12">
                    <span class="text-red-600">S·ªë ti·ªÅn b·∫±ng ch·ªØ:</span> <span id="preview-so-tien-chu">...</span>
                    <div class="border-b border-dotted border-gray-500 leading-none mt-0.5"></div>
                </div>

                <!-- Ch·ªØ k√Ω - ƒê√É B·ªé THEO Y√äU C·∫¶U -->
                <div class="grid grid-cols-2 text-center text-sm mt-10">
                    <!-- Ng∆∞·ªùi b√°n h√†ng (Ph·∫£i) -->
                    <div class="col-span-2 text-right pr-4">
                        <p class="font-bold mb-4">Ng∆∞·ªùi b√°n h√†ng</p>
                        <br><br><br><br><br>
                    </div>
                </div>

            </div>
            
            <div id="initial-message" class="bg-yellow-100 p-6 rounded-xl shadow-lg text-center mt-6">
                <p class="text-xl font-semibold text-yellow-800">Vui l√≤ng nh·∫≠p th√¥ng tin v√†o bi·ªÉu m·∫´u b√™n tr√°i v√† nh·∫•n "Xem & T·∫°o H√≥a ƒê∆°n" ƒë·ªÉ xem tr∆∞·ªõc.</p>
            </div>
        </div>
    </div>

    <script>
        // ƒê·ªãnh nghƒ©a c√°c lo·∫°i Gas v√† ƒë∆°n gi√° c·ªë ƒë·ªãnh (ƒë√£ s·∫Øp x·∫øp gi·∫£m d·∫ßn theo gi√°)
        const GAS_PRODUCTS = [
            { ten_hang: "B√¨nh Gas 45kg (C√¥ng nghi·ªáp)", dvt: "B√¨nh", don_gia: 950000 },
            { ten_hang: "B√¨nh Gas 12kg (ƒê·ªè)", dvt: "B√¨nh", don_gia: 300000 },
            { ten_hang: "B√¨nh Gas 12kg (X√°m)", dvt: "B√¨nh", don_gia: 250000 },
            { ten_hang: "B√¨nh Gas Mini (6kg)", dvt: "B√¨nh", don_gia: 120000 }
        ];

        // Gi·ªõi h·∫°n Ph√≠ D·ªãch V·ª•
        const MIN_FEE = 30000;
        const MAX_FEE = 400000; 

        // H√†m ƒë·ªãnh d·∫°ng s·ªë c√≥ d·∫•u ph√¢n c√°ch h√†ng ngh√¨n
        function formatCurrency(number) {
            return new Intl.NumberFormat('vi-VN', { style: 'decimal' }).format(number);
        }

        // H√†m x√≥a ƒë·ªãnh d·∫°ng s·ªë ƒë·ªÉ l·∫•y gi√° tr·ªã s·ªë th·ª±c
        function unformatCurrency(text) {
            // ƒê·∫£m b·∫£o x·ª≠ l√Ω c·∫£ tr∆∞·ªùng h·ª£p r·ªóng ho·∫∑c kh√¥ng ph·∫£i s·ªë
            if (!text) return 0;
            // X√≥a t·∫•t c·∫£ d·∫•u ch·∫•m, chuy·ªÉn th√†nh s·ªë nguy√™n
            return parseInt(text.replace(/\./g, ''), 10) || 0;
        }

        // H√†m ƒë·ªãnh d·∫°ng s·ªë khi ng∆∞·ªùi d√πng nh·∫≠p (v√≠ d·ª•: 1000000 -> 1.000.000)
        function formatNumber(input) {
            let value = input.value.replace(/\./g, ''); // X√≥a d·∫•u ch·∫•m c≈©
            if (value) {
                // Th√™m d·∫•u ch·∫•m
                input.value = formatCurrency(parseInt(value));
            }
        }


        function generateInvoice() {
            // L·∫•y d·ªØ li·ªáu t·ª´ form
            const ten_cong_ty = document.getElementById('ten_cong_ty').value;
            const dia_chi = document.getElementById('dia_chi').value;
            const dien_thoai = document.getElementById('dien_thoai').value;
            const gio = document.getElementById('gio').value;
            const phut = document.getElementById('phut').value;
            const ngay = document.getElementById('ngay').value;
            const thang = document.getElementById('thang').value;
            const nam = document.getElementById('nam').value;
            const so_hoa_don = document.getElementById('so_hoa_don').value;
            const so_tien_chu = document.getElementById('so_tien_chu').value;
            const ten_nguoi_mua = document.getElementById('ten_nguoi_mua').value;
            const tong_so_tien_input = document.getElementById('tong_so_tien_input').value;
            
            // X·ª≠ l√Ω T·ªïng s·ªë ti·ªÅn nh·∫≠p v√†o (chuy·ªÉn sang s·ªë nguy√™n)
            const TONG_TIEN_KHACH_TRA = unformatCurrency(tong_so_tien_input);
            

            // --- Logic t√≠nh to√°n t·ª± ƒë·ªông (Greedy Algorithm) ---
            
            let products = [];
            let currentStt = 1;
            let totalGasCost = 0;

            // 1. √Åp d·ª•ng gi·ªõi h·∫°n MIN_FEE ƒë·ªÉ t√¨m s·ªë ti·ªÅn t·ªëi ƒëa c√≥ th·ªÉ chi cho Gas
            // N·∫øu kh√°ch tr·∫£ qu√° √≠t (d∆∞·ªõi MIN_FEE), th√¨ ti·ªÅn cho Gas b·∫±ng 0.
            let maxMoneyForGas = Math.max(0, TONG_TIEN_KHACH_TRA - MIN_FEE);
            let gasMoneyToSpend = maxMoneyForGas;
            
            // 2. Ch·∫°y thu·∫≠t to√°n tham lam (Greedy)
            GAS_PRODUCTS.forEach(product => {
                if (gasMoneyToSpend >= product.don_gia) {
                    const so_luong = Math.floor(gasMoneyToSpend / product.don_gia);
                    const thanh_tien = so_luong * product.don_gia;
                    
                    products.push({
                        stt: currentStt++,
                        ten_hang: product.ten_hang, 
                        dvt: product.dvt,
                        so_luong: so_luong,
                        don_gia: product.don_gia,
                        thanh_tien: thanh_tien,
                        ghi_chu: ""
                    });

                    gasMoneyToSpend -= thanh_tien;
                    totalGasCost += thanh_tien;
                }
            });

            // 3. T√≠nh Ph√≠ D·ªãch V·ª• (Remainder)
            let phi_dich_vu = TONG_TIEN_KHACH_TRA - totalGasCost;

            // 4. Th√™m d√≤ng Ph√≠ D·ªãch V·ª• (n·∫øu c√≥ v√† > 0)
            if (phi_dich_vu > 0) {
                 let ghi_chu_phi = "Chi ph√≠ v·∫≠n chuy·ªÉn/l·∫Øp ƒë·∫∑t";
                 if (phi_dich_vu > MAX_FEE) {
                     // N·∫øu ph√≠ d·ªãch v·ª• v∆∞·ª£t qu√° MAX_FEE, ch·ªâ ghi nh·∫≠n ph√≠ th·ª±c t·∫ø (ƒê√¢y l√† tr∆∞·ªùng h·ª£p kh√°ch tr·∫£ ti·ªÅn nh∆∞ng kh√¥ng mua ƒë∆∞·ª£c Gas th√™m)
                     ghi_chu_phi += ` (L∆∞u √Ω: Ph√≠ D·ªãch V·ª• v∆∞·ª£t qu√° ${formatCurrency(MAX_FEE)} VNƒê quy ƒë·ªãnh)`;
                 } else if (phi_dich_vu < MIN_FEE) {
                    // Tr∆∞·ªùng h·ª£p n√†y g·∫ßn nh∆∞ kh√¥ng x·∫£y ra do logic maxMoneyForGas ·ªü b∆∞·ªõc 1, nh∆∞ng th√™m v√†o ƒë·ªÉ ƒë·∫£m b·∫£o.
                    ghi_chu_phi += ` (L∆∞u √Ω: Ph√≠ D·ªãch V·ª• d∆∞·ªõi ${formatCurrency(MIN_FEE)} VNƒê)`;
                 }

                 products.push({
                    stt: currentStt++,
                    ten_hang: "Ph√≠ D·ªãch V·ª•",
                    dvt: "L·∫ßn",
                    so_luong: 1,
                    don_gia: phi_dich_vu,
                    thanh_tien: phi_dich_vu,
                    ghi_chu: ghi_chu_phi
                });
            }


            // --- Hi·ªÉn th·ªã l√™n Preview ---

            // 1. C·∫≠p nh·∫≠t ng√†y/s·ªë h√≥a ƒë∆°n
            document.getElementById('preview-date-number').textContent = 
                `${gio}:${phut} Ng√†y ${ngay} th√°ng ${thang} nƒÉm ${nam} ... S·ªë: ${so_hoa_don}`;

            // 2. C·∫≠p nh·∫≠t th√¥ng tin H·ªô Kinh Doanh
            document.getElementById('preview-ten-cong-ty').textContent = ten_cong_ty;
            document.getElementById('preview-dia_chi').textContent = dia_chi;
            document.getElementById('preview-dien_thoai').textContent = `${dien_thoai}`;

            // 3. C·∫≠p nh·∫≠t th√¥ng tin Kh√°ch h√†ng
            document.getElementById('preview-ten-nguoi-mua').textContent = ten_nguoi_mua; 

            // 4. T·∫°o n·ªôi dung b·∫£ng s·∫£n ph·∫©m
            const tableBody = document.getElementById('product-table-body');
            tableBody.innerHTML = ''; // X√≥a n·ªôi dung c≈©

            products.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="border border-black p-1 text-center">${item.stt}</td>
                    <td class="border border-black p-1">${item.ten_hang}</td>
                    <td class="border border-black p-1 text-center">${item.dvt}</td>
                    <td class="border border-black p-1 text-right">${formatCurrency(item.so_luong)}</td>
                    <td class="border border-black p-1 text-right">${formatCurrency(item.don_gia)}</td>
                    <td class="border border-black p-1 text-right">${formatCurrency(item.thanh_tien)}</td>
                    <td class="border border-black p-1">${item.ghi_chu}</td>
                `;
            });
            
            // D√≤ng T·ªïng c·ªông cu·ªëi c√πng
            const totalRow = tableBody.insertRow();
            totalRow.innerHTML = `
                <td colspan="2" class="border border-black p-1 font-bold text-center">T·ªïng:</td>
                <td colspan="3" class="border border-black p-1"></td>
                <td class="border border-black p-1 font-bold text-right">${formatCurrency(TONG_TIEN_KHACH_TRA)}</td>
                <td class="border border-black p-1"></td>
            `;

            // 5. C·∫≠p nh·∫≠t s·ªë ti·ªÅn b·∫±ng ch·ªØ
            document.getElementById('preview-so-tien-chu').textContent = so_tien_chu;

            // Hi·ªÉn th·ªã preview v√† n√∫t In/T·∫£i xu·ªëng
            document.getElementById('invoice-preview').classList.remove('hidden');
            document.getElementById('print-button').classList.remove('hidden');
            document.getElementById('download-button').classList.remove('hidden');
            document.getElementById('initial-message').classList.add('hidden');
        }

        // H√†m T·∫£i xu·ªëng PDF
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const input = document.getElementById('invoice-preview');

            // C·∫•u h√¨nh ƒë·ªÉ html2canvas gi·ªØ nguy√™n k√≠ch th∆∞·ªõc v√† ch·∫•t l∆∞·ª£ng
            const canvas = await html2canvas(input, {
                scale: 2, // TƒÉng ƒë·ªô ph√¢n gi·∫£i ƒë·ªÉ h√¨nh ·∫£nh kh√¥ng b·ªã m·ªù
                useCORS: true,
                logging: true
            });

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'in',
                format: 'letter' // K√≠ch th∆∞·ªõc gi·∫•y th∆∞ (g·∫ßn gi·ªëng A4)
            });
            
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            
            const imgWidth = 7.75; // Chi·ªÅu r·ªông c·ªë ƒë·ªãnh c·ªßa h√≥a ƒë∆°n
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            // T√≠nh to√°n v·ªã tr√≠ ƒë·ªÉ cƒÉn gi·ªØa
            const x = (pdfWidth - imgWidth) / 2;
            const y = 0.2; // L·ªÅ tr√™n

            pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
            
            // T·∫°o t√™n file d·ª±a tr√™n th√¥ng tin h√≥a ƒë∆°n
            const so_hoa_don = document.getElementById('so_hoa_don').value || '0000';
            const ten_nguoi_mua = document.getElementById('ten_nguoi_mua').value || 'KhachHang';
            const ngay = document.getElementById('ngay').value;
            const thang = document.getElementById('thang').value;

            const fileName = `HD_${so_hoa_don}_${ten_nguoi_mua}_${ngay}${thang}.pdf`;
            
            pdf.save(fileName);
        }

        // ƒê·∫∑t m·∫∑c ƒë·ªãnh ng√†y th√°ng nƒÉm hi·ªán t·∫°i n·∫øu ng∆∞·ªùi d√πng ch∆∞a nh·∫≠p
        window.onload = function() {
            const today = new Date();
            document.getElementById('ngay').value = today.getDate();
            document.getElementById('thang').value = today.getMonth() + 1;
            document.getElementById('nam').value = today.getFullYear();
        }
    </script>
</body>
</html>
